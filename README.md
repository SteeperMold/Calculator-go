# Распределённый вычислитель арифметических выражений

Данный проект реализует распределённую систему вычисления арифметических выражений. Система состоит из двух основных
компонентов:

- **Оркестратор (Сервер):** Принимает арифметическое выражение, разбивает его на последовательность вычислительных задач
  и обеспечивает корректный порядок их выполнения.
- **Агент (Вычислитель):** Получает от оркестратора отдельные задачи, выполняет требуемые операции (которые намеренно
  затрачивают значительные вычислительные ресурсы) и возвращает результат обратно серверу.

Система позволяет выполнять отдельные арифметические операции параллельно, что обеспечивает возможность масштабирования
за счёт добавления новых вычислительных агентов.

------------------------------------------------------------

## Содержание

- [Архитектура](#архитектура)
- [API эндпоинты](#api-эндпоинты)
    - [1. Отправка арифметического выражения](#1-отправка-арифметического-выражения)
    - [2. Получение списка выражений](#2-получение-списка-выражений)
    - [3. Получение выражения по идентификатору](#3-получение-выражения-по-идентификатору)
    - [4. Получение задачи для вычисления (внутренний эндпоинт)](#4-получение-задачи-для-вычисления-внутренний-эндпоинт)
    - [5. Отправка результата вычисления задачи (внутренний эндпоинт)](#5-отправка-результата-вычисления-задачи-внутренний-эндпоинт)
- [Переменные окружения](#переменные-окружения)
- [Запуск проекта](#запуск-проекта)
    - [Запуск через Go](#запуск-через-go)
    - [Запуск через Docker Compose](#запуск-через-docker-compose)
- [Тестирование](#тестирование)
- [Примеры использования с curl](#примеры-использования-с-curl)
- [Схема системы](#схема-системы)
- [Заключение](#заключение)

------------------------------------------------------------

## Архитектура

Проект состоит из двух основных частей:

1. **Оркестратор (Сервер):**
    - Принимает арифметические выражения через HTTP.
    - Разбивает выражение на отдельные вычислительные задачи.
    - Управляет порядком выполнения задач и отслеживает статус выражений.
    - Предоставляет клиентам возможность получить статус и результат вычисления.

2. **Агент (Вычислитель):**
    - Запускается как демон с несколькими параллельными рабочими (число которых определяется переменной
      окружения `COMPUTING_POWER`).
    - Постоянно опрашивает оркестратора для получения новых задач через внутренний HTTP эндпоинт.
    - Выполняет полученные задачи и отправляет результат обратно.

3. **Frontend:**
    - Написан на React.js
    - Предоставляет интерфейс для общения человека с http-сервером

------------------------------------------------------------

## API эндпоинты

### 1. Отправка арифметического выражения

**Эндпоинт:**  
`POST /api/v1/calculate`

**Пример запроса:**

    curl --location 'localhost/api/v1/calculate' \
    --header 'Content-Type: application/json' \
    --data '{
      "expression": "2+2*2"
    }'

**Коды ответа:**

- **201:** Выражение принято на вычисление.
- **422:** Невалидные данные.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
      "id": <уникальный_идентификатор_выражения>
    }

------------------------------------------------------------

### 2. Получение списка выражений

**Эндпоинт:**  
`GET /api/v1/expressions`

**Пример запроса:**

    curl --location 'localhost/api/v1/expressions'

**Коды ответа:**

- **200:** Список выражений получен успешно.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "expressions": [
            {
                "id": 1,
                "status": "in_progress",
                "result": null
            },
            {
                "id": 2,
                "status": "completed",
                "result": 6
            }
        ]
    }

------------------------------------------------------------

### 3. Получение выражения по идентификатору

**Эндпоинт:**  
`GET /api/v1/expressions/:id`

**Пример запроса:**

    curl --location 'localhost/api/v1/expressions/1'

**Коды ответа:**

- **200:** Выражение найдено.
- **404:** Выражение не найдено.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "expression": {
            "id": 1,
            "status": "completed",
            "result": 6
        }
    }

------------------------------------------------------------

### 4. Получение задачи для вычисления (внутренний эндпоинт)

**Эндпоинт:**  
`GET /internal/task`

**Пример запроса:**

    curl --location 'localhost/internal/task'

**Коды ответа:**

- **200:** Задача получена успешно.
- **404:** Нет доступных задач.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "task": {
            "id": <идентификатор_задачи>,
            "arg1": <значение_первого_аргумента>,
            "arg2": <значение_второго_аргумента>,
            "operation": <операция>,
            "operation_time": <время_операции_в_мс>
        }
    }

------------------------------------------------------------

### 5. Отправка результата вычисления задачи (внутренний эндпоинт)

**Эндпоинт:**  
`POST /internal/task`

**Пример запроса:**

    curl --location 'localhost/internal/task' \
    --header 'Content-Type: application/json' \
    --data '{
      "id": 1,
      "result": 2.5
    }'

**Коды ответа:**

- **200:** Результат успешно записан.
- **404:** Задача не найдена.
- **422:** Невалидные данные.
- **500:** Внутренняя ошибка.

------------------------------------------------------------

## Переменные окружения

Для имитации затрат вычислительных ресурсов при выполнении операций используются следующие переменные окружения (время
указывается в миллисекундах):

- `PORT` - порт на котором должен запускаться оркестратор.
- `TIME_ADDITION_MS` – время выполнения операции сложения.
- `TIME_SUBTRACTION_MS` – время выполнения операции вычитания.
- `TIME_MULTIPLICATIONS_MS` – время выполнения операции умножения.
- `TIME_DIVISIONS_MS` – время выполнения операции деления.

Для агента:

- `ORCHESTRATOR_ADDRESS` - адрес на котором работает оркестратор.
- `COMPUTING_POWER` – количество параллельных горутин (рабочих), выполняющих вычисления.

------------------------------------------------------------

## Запуск проекта

### Запуск через Go

1. Запуск оркестратора

        cd orchestrator
        go mod download
        go run cmd/main.go

2. Запуск агента

        cd agent
        go mod download
        go run cmd/main.go

3. Запуск фронтенда

        cd frontend
        npm i
        npm run start

------------------------------------------------------------

## Примеры использования с curl

### Отправка арифметического выражения

       curl --location 'localhost/api/v1/calculate' \
       --header 'Content-Type: application/json' \
       --data '{
         "expression": "2+2*2"
       }'

*Ожидаемый ответ (201):*

       {
         "id": 1
       }

------------------------------------------------------------

### Получение статуса всех выражений

       curl --location 'localhost/api/v1/expressions'

*Ожидаемый ответ (200):*

       {
         "expressions": [
           {
             "id": 1,
             "status": "in_progress",
             "result": null
           }
         ]
       }

------------------------------------------------------------

### Получение конкретного выражения по идентификатору

       curl --location 'localhost/api/v1/expressions/1'

*Ожидаемый ответ (200):*

       {
         "expression": {
           "id": 1,
           "status": "completed",
           "result": 6
         }
       }

------------------------------------------------------------

### Агент: Получение задачи

       curl --location 'localhost/internal/task'

*Ожидаемый ответ (200) при наличии задачи:*

       {
         "task": {
           "id": 101,
           "arg1": "2",
           "arg2": "2",
           "operation": "addition",
           "operation_time": 1000
         }
       }

------------------------------------------------------------

### Агент: Отправка результата вычисления

       curl --location 'localhost/internal/task' \
       --header 'Content-Type: application/json' \
       --data '{
         "id": 101,
         "result": 4
       }'

*Ожидаемый ответ (200):* Подтверждение успешного сохранения результата.

------------------------------------------------------------

## Схема системы

Ниже представлена упрощённая схема архитектуры:

       +-------------------------+         +-------------------------+
       |  Клиент (curl, браузер) |         |   Веб-интерфейс (опц.)  |
       +-------------------------+         +-------------------------+
                   |                                  |
                   v                                  v
       +-----------------------------------------------------------+
       |                        Оркестратор                        |
       |  - Принимает арифметические выражения                     |
       |  - Разбивает выражения на отдельные задачи                |
       |  - Эндпоинты:                                             |
       |       /api/v1/calculate,                                  |
       |       /api/v1/expressions,                                |
       |       /api/v1/expressions/:id,                            |
       |       /internal/task                                      |
       +-----------------------------------------------------------+
                   ^
                   |
                   |  HTTP
                   |
       +-----------------------------------------------------------+
       |                          Агент                            |
       |  - Опрашивает задачи: GET /internal/task                  |
       |  - Вычисляет задачи параллельно (на основе                |
       |    COMPUTING_POWER)                                       |
       |  - Отправляет результат: POST /internal/task              |
       +-----------------------------------------------------------+

------------------------------------------------------------

Удачных вычислений!
