# Распределённый вычислитель арифметических выражений

Данный проект реализует распределённую систему вычисления арифметических выражений. Система состоит из двух основных
компонентов:

- **Оркестратор (Сервер):** Принимает арифметическое выражение, разбивает его на последовательность вычислительных задач
  и обеспечивает корректный порядок их выполнения.
- **Агент (Вычислитель):** Получает от оркестратора отдельные задачи, выполняет требуемые операции (которые намеренно
  затрачивают значительные вычислительные ресурсы) и возвращает результат обратно серверу.

Система позволяет выполнять отдельные арифметические операции параллельно, что обеспечивает возможность масштабирования
за счёт добавления новых вычислительных агентов.

------------------------------------------------------------

## Содержание

- [Архитектура](#архитектура)
- [API эндпоинты](#api-эндпоинты)
    - [1. Регистрация](#1-регистрация)
    - [2. Вход в аккаунт](#2-вход-в-аккаунт)
    - [3. Отправка арифметического выражения](#3-отправка-арифметического-выражения)
    - [4. Получение списка выражений](#4-получение-списка-выражений)
    - [5. Получение выражения по идентификатору](#5-получение-выражения-по-идентификатору)
- [Переменные окружения](#переменные-окружения)
- [Запуск проекта](#запуск-проекта)
    - [Запуск через Go](#запуск-через-go)
- [Примеры использования с curl](#примеры-использования-с-curl)
- [Схема системы](#схема-системы)

------------------------------------------------------------

## Архитектура

Проект состоит из двух основных частей:

1. **Оркестратор (Сервер):**
    - Принимает арифметические выражения через HTTP.
    - Разбивает выражение на отдельные вычислительные задачи.
    - Управляет порядком выполнения задач и отслеживает статус выражений.
    - Предоставляет клиентам возможность получить статус и результат вычисления.

2. **Агент (Вычислитель):**
    - Запускается как демон с несколькими параллельными рабочими (число которых определяется переменной
      окружения `COMPUTING_POWER`).
    - Постоянно опрашивает оркестратора для получения новых задач через внутренний HTTP эндпоинт.
    - Выполняет полученные задачи и отправляет результат обратно.

3. **Frontend:**
    - Написан на React.js
    - Предоставляет интерфейс для общения человека с http-сервером

------------------------------------------------------------

## API эндпоинты

### 1. Регистрация

**Эндпоинт:**  
`POST /api/v1/register`

**Пример запроса:**

    curl --request POST \
    --location 'localhost/api/v1/register' \
    --header 'Content-Type: application/json' \
    --data '{
      "login": "example",
      "password": "example_password"
    }'

**Коды ответа:**

- **200:** Аккаунт успешно создан.
- **422:** Невалидные данные.
- **409:** Такой пользователь уже существует.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    OK

------------------------------------------------------------

### 2. Вход в аккаунт

**Эндпоинт:**  
`POST /api/v1/login`

**Пример запроса:**

    curl --request POST \
    --location 'localhost/api/v1/login' \
    --header 'Content-Type: application/json' \
    --data '{
      "login": "example",
      "password": "example_password"
    }'

**Коды ответа:**

- **200:** Аккаунт успешно создан.
- **422:** Неверный логин или пароль.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "accessToken": "token",
        "refreshToken": "token"
    }

------------------------------------------------------------

### 3. Отправка арифметического выражения

**Эндпоинт:**  
`POST /api/v1/calculate`

**Пример запроса:**

    curl --location 'localhost/api/v1/calculate' \
    --header 'Content-Type: application/json' \
    --header 'Authorization: Bearer $ACCESS_TOKEN' \
    --data '{
      "expression": "2+2*2"
    }'

**Коды ответа:**

- **201:** Выражение принято на вычисление.
- **422:** Невалидные данные.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
      "id": <уникальный_идентификатор_выражения>
    }

------------------------------------------------------------

### 4. Получение списка выражений

**Эндпоинт:**  
`GET /api/v1/expressions`

**Пример запроса:**

    curl --location 'localhost/api/v1/expressions'

**Коды ответа:**

- **200:** Список выражений получен успешно.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "expressions": [
            {
                "id": 1,
                "status": "in_progress",
                "result": null
            },
            {
                "id": 2,
                "status": "completed",
                "result": 6
            }
        ]
    }

------------------------------------------------------------

### 5. Получение выражения по идентификатору

**Эндпоинт:**  
`GET /api/v1/expressions/:id`

**Пример запроса:**

    curl --location 'localhost/api/v1/expressions/1'

**Коды ответа:**

- **200:** Выражение найдено.
- **404:** Выражение не найдено.
- **500:** Внутренняя ошибка.

**Тело ответа:**

    {
        "expression": {
            "id": 1,
            "status": "completed",
            "result": 6
        }
    }

------------------------------------------------------------

## Переменные окружения

Для имитации затрат вычислительных ресурсов при выполнении операций используются следующие переменные окружения (время
указывается в миллисекундах):

- `PORT` - порт на котором должен запускаться оркестратор.
- `TIME_ADDITION_MS` – время выполнения операции сложения.
- `TIME_SUBTRACTION_MS` – время выполнения операции вычитания.
- `TIME_MULTIPLICATIONS_MS` – время выполнения операции умножения.
- `TIME_DIVISIONS_MS` – время выполнения операции деления.
- `ACCESS_TOKEN_SECRET` - секрет для access jwt токенов.
- `ACCESS_TOKEN_EXPIRY_HOURS` - время жизни access jwt токенов в часах.
- `REFRESH_TOKEN_SECRET` - секрет для refresh jwt токенов.
- `REFRESH_TOKEN_EXPIRY_HOURS` - время жизни refresh jst токенов в часах.

Для агента:

- `ORCHESTRATOR_ADDRESS` - адрес на котором работает оркестратор.
- `COMPUTING_POWER` – количество параллельных горутин (рабочих), выполняющих вычисления.

------------------------------------------------------------

## Запуск проекта

### Запуск через Go

1. Запуск оркестратора

        cd orchestrator
        go mod download
        go run cmd/main.go

2. Запуск агента

        cd agent
        go mod download
        go run cmd/main.go

3. Запуск фронтенда

        cd frontend
        npm i
        npm run start

------------------------------------------------------------

## Примеры использования с curl

### Регистрация

    curl --request POST \
    --location 'localhost/api/v1/register' \
    --header 'Content-Type: application/json' \
    --data '{
      "login": "example",
      "password": "example_password"
    }'


*Ожидаемый ответ (200):*

    OK

------------------------------------------------------------

### Вход в аккаунт

    curl --request POST \
    --location 'localhost/api/v1/login' \
    --header 'Content-Type: application/json' \
    --data '{
      "login": "example",
      "password": "example_password"
    }'

*Ожидаемый ответ (200):*

    {
        "accessToken": "token",
        "refreshToken": "token"
    }

Используйте полученный `accessToken` в качестве переменной `$ACCESS_TOKEN`

------------------------------------------------------------

### Отправка арифметического выражения

    curl --location 'localhost/api/v1/calculate' \
    --header 'Content-Type: application/json' \
    --header 'Authorization: Bearer $ACCESS_TOKEN' \
    --data '{
      "expression": "2+2*2"
    }'

*Ожидаемый ответ (201):*

       {
         "id": 1
       }

------------------------------------------------------------

### Получение статуса всех выражений

       curl --location 'localhost/api/v1/expressions'

*Ожидаемый ответ (200):*

       {
         "expressions": [
           {
             "id": 1,
             "status": "in_progress",
             "result": null
           }
         ]
       }

------------------------------------------------------------

### Получение конкретного выражения по идентификатору

       curl --location 'localhost/api/v1/expressions/1'

*Ожидаемый ответ (200):*

       {
         "expression": {
           "id": 1,
           "status": "completed",
           "result": 6
         }
       }

------------------------------------------------------------

## Схема системы

Ниже представлена упрощённая схема архитектуры:

       +-------------------------+         +-------------------------+
       |  Клиент (curl, браузер) |         |   Веб-интерфейс (опц.)  |
       +-------------------------+         +-------------------------+
                   |                                  |
                   v                                  v
       +-----------------------------------------------------------+
       |                        Оркестратор                        |
       |  - Принимает арифметические выражения                     |
       |  - Разбивает выражения на отдельные задачи                |
       |  - Основные эндпоинты:                                    |
       |       /api/v1/calculate,                                  |
       |       /api/v1/expressions,                                |
       |       /api/v1/expressions/:id,                            |
       +-----------------------------------------------------------+
                   ^
                   |
                   |  gRPC
                   |
       +-----------------------------------------------------------+
       |                          Агент                            |
       |  - Опрашивает задачи: rpc FetchTask                       |
       |  - Вычисляет задачи параллельно (на основе                |
       |    COMPUTING_POWER)                                       |
       |  - Отправляет результат: rpc SendResult                   |
       +-----------------------------------------------------------+

------------------------------------------------------------

Удачных вычислений!
